<div class="sdp-transactions-container">

  <h2>SDP Transactions</h2>

  <!-- Toast Notification -->
<div class="toast" *ngIf="toastMessage" [ngClass]="toastType">
  <span class="toast-icon">
    <i *ngIf="toastType === 'success'" class="fa-solid fa-circle-check"></i>
    <i *ngIf="toastType === 'info'" class="fa-solid fa-circle-info"></i>
    <i *ngIf="toastType === 'error'" class="fa-solid fa-circle-xmark"></i>
  </span>
  {{ toastMessage }}
</div>


  <div class="table-responsive">
    <table class="transactions-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>College</th>
          <th>Mode</th>
          <th>Amount</th>
          <th>Txn / Ref No</th>
          <th>Date</th>
          <th *ngIf="isFinance" class="action-col">Action</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let row of rows; let i = index" [class.editing]="row.isEdit">
          <td>{{ row.student_name }}</td>
          <td>{{ row.college_name }}</td>

          <!-- Payment Mode -->
          <td class="mode-cell">
            <ng-container *ngIf="!row.isEdit">
              <span class="badge" [ngClass]="getModeClass(row.payment_mode)">
                {{ row.payment_mode || '—' }}
              </span>
            </ng-container>

            <ng-container *ngIf="row.isEdit">
              <div class="select-wrapper" role="combobox" aria-haspopup="listbox">
                <label for="mode-{{i}}" class="sr-only">Payment Mode</label>
          <select id="mode-{{i}}" [(ngModel)]="row.payment_mode" class="form-select" required aria-required="true"
            (change)="onModeChange(row)" attr.aria-describedby="mode-error-{{i}}">
            <option value="" disabled>Select mode</option>
            <option value="RTGS">RTGS</option>
            <option value="NEFT">NEFT</option>
            <option value="CHEQUE">Cheque</option>
            <option value="UPI">UPI</option>
          </select>

<span id="mode-error-{{i}}" class="error-text" *ngIf="!row.payment_mode && row.submitted">
  Payment mode is required
</span>

                <span id="mode-error-{{i}}" class="error-text" *ngIf="!row.payment_mode && row.submitted">
                  Payment mode is required
                </span>
              </div>
            </ng-container>
          </td>

          <!-- Amount -->
          <td>
            <ng-container *ngIf="!row.isEdit">
              {{ row.amount | number:'1.2-2' }}
            </ng-container>
            <input
              *ngIf="row.isEdit"
              type="number"
              [(ngModel)]="row.amount"
              class="form-input"
              min="1"
              step="0.01"
              required
              aria-required="true"
              [attr.aria-invalid]="!row.amount && row.submitted"
            />
          </td>

          <!-- Txn / Ref No -->
          <td>
            <ng-container *ngIf="!row.isEdit">
              {{ row.transaction_id || '—' }}
            </ng-container>
        <input *ngIf="row.isEdit" [(ngModel)]="row.transaction_id" class="form-input"
          [class.input-error]="row.submitted && !isTxnValid(row)" [placeholder]="getTxnPlaceholder(row.payment_mode)"
          required />

          
          <div class="error-text" *ngIf="row.submitted && !isTxnValid(row)">
            {{ getTxnError(row.payment_mode) }}
          </div>

          </td>

          <!-- Date -->
          <td>
            <ng-container *ngIf="!row.isEdit">
              {{ row.payment_date | date:'dd-MM-yyyy' }}
            </ng-container>
            <input
              *ngIf="row.isEdit"
              type="date"
              [(ngModel)]="row.payment_date"
              class="form-input"
              required
              aria-required="true"
              [attr.aria-invalid]="!row.payment_date && row.submitted"
            />
          </td>

          <!-- Actions (Finance only) -->
          <td *ngIf="isFinance" class="action-col">
            <ng-container *ngIf="!row.isEdit">
              <button class="btn btn-edit" (click)="startEdit(row)" aria-label="Edit transaction">
                <i class="fa-solid fa-pen"></i> Edit
              </button>
            </ng-container>

            <ng-container *ngIf="row.isEdit">
              <button class="btn btn-save" (click)="save(row)" aria-label="Save changes">
                <i class="fa-solid fa-check"></i> Save
              </button>
              <button class="btn btn-cancel" (click)="cancel(row)" aria-label="Cancel editing">
                <i class="fa-solid fa-xmark"></i> Cancel
              </button>
            </ng-container>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!rows.length" class="empty-state">
    No transactions found
  </div>

</div>
